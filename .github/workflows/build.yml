name: CI - Build Check

on:
  push:
    branches: [ bewilson/ci-cd/ ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: almalinux:9
      options: --privileged

    steps:
    - name: Install dependencies
      run: |
        dnf -y install epel-release
        dnf -y install git cmake gcc gcc-c++ make fuse fuse3 cvmfs cvmfs-config-default

    - name: Mount CVMFS
      run: |
        mkdir -p /cvmfs
        echo "CVMFS_REPOSITORIES=sft.cern.ch" >> /etc/cvmfs/default.local
        echo "CVMFS_QUOTA_LIMIT=10000" >> /etc/cvmfs/default.local
        cvmfs_config setup
        cvmfs_config probe

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Source LCG environment
      run: |
        source /cvmfs/sft.cern.ch/lcg/views/LCG_107/x86_64-el9-gcc11-opt/setup.sh

    - name: Configure and build
      run: |
        mkdir -p build
        cd build
        cmake ..
        make -j$(nproc)
